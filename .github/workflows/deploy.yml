name: Deploy

on:
  push:
    branches:
      - dev
      - main
      - "feature/**"
  workflow_dispatch:
    inputs:
      allow_stack_delete:
        description: Allow deleting ROLLBACK_COMPLETE stacks (dev only)
        required: false
        default: 'false'

permissions:
  id-token: write
  contents: read

jobs:
  backend-dev:
    if: startsWith(github.ref, 'refs/heads/feature/') || github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    env:
      ALLOW_STACK_DELETE: ${{ github.event_name == 'workflow_dispatch' && inputs.allow_stack_delete || 'false' }}
    concurrency:
      group: deploy-dev
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Show GITHUB_REF
        run: echo "GITHUB_REF=$GITHUB_REF"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}

      - name: Verify caller
        run: aws sts get-caller-identity

      - name: Build and upload backend lambda (dev)
        run: |
          set -euo pipefail
          npm ci --include=optional
          npm run build --workspace=apps/api

          rm -rf .artifacts/backend
          mkdir -p .artifacts/backend
          cp -r apps/api/dist .artifacts/backend/dist
          cp apps/api/package.json .artifacts/backend/package.json

          pushd .artifacts/backend >/dev/null
          npm install --omit=dev --ignore-scripts
          zip -qr backend-lambda.zip dist node_modules package.json
          popd >/dev/null

          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          DEV_BACKEND_CODE_BUCKET="${{ vars.BACKEND_CODE_BUCKET_DEV }}"
          if [ -z "$DEV_BACKEND_CODE_BUCKET" ]; then DEV_BACKEND_CODE_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_DEV }}"; fi
          if [ -z "$DEV_BACKEND_CODE_BUCKET" ]; then DEV_BACKEND_CODE_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET }}"; fi
          if [ -z "$DEV_BACKEND_CODE_BUCKET" ]; then DEV_BACKEND_CODE_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_NAME }}"; fi
          if [ -z "$DEV_BACKEND_CODE_BUCKET" ]; then DEV_BACKEND_CODE_BUCKET="kondate-loop-infra-s3-artifacts-211669976488-ap-northeast-1"; fi
          DEV_BACKEND_CODE_BUCKET="${DEV_BACKEND_CODE_BUCKET#arn:aws:s3:::}"

          LAMBDA_CODE_S3_KEY="backend/${GITHUB_SHA}/backend-lambda.zip"
          aws s3 cp .artifacts/backend/backend-lambda.zip "s3://${DEV_BACKEND_CODE_BUCKET}/${LAMBDA_CODE_S3_KEY}"
          echo "LAMBDA_CODE_S3_BUCKET=$DEV_BACKEND_CODE_BUCKET" >> "$GITHUB_ENV"
          echo "LAMBDA_CODE_S3_KEY=$LAMBDA_CODE_S3_KEY" >> "$GITHUB_ENV"

      - name: Deploy CloudFormation (dev)
        run: |
          ENV_NAME=dev
          INFRA_STACK_NAME="${{ vars.CFN_STACK_NAME_DEV }}"
          if [ -z "$INFRA_STACK_NAME" ]; then INFRA_STACK_NAME="${{ vars.CFN_STACK_NAME }}"; fi
          if [ -z "$INFRA_STACK_NAME" ]; then INFRA_STACK_NAME="kondate-loop-infra-stack-${ENV_NAME}"; fi

          EXEC_ROLE_ARN="${{ secrets.CFN_EXEC_ROLE_ARN_DEV }}"
          if [ -z "$EXEC_ROLE_ARN" ]; then EXEC_ROLE_ARN="${{ vars.CFN_EXEC_ROLE_ARN_DEV }}"; fi
          if [ -z "$EXEC_ROLE_ARN" ]; then EXEC_ROLE_ARN="${{ vars.CFN_EXEC_ROLE_ARN }}"; fi

          ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_DEV }}"
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET }}"; fi
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_NAME }}"; fi
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="kondate-loop-infra-s3-artifacts-211669976488-ap-northeast-1"; fi
          ARTIFACT_BUCKET="${ARTIFACT_BUCKET#arn:aws:s3:::}"

          if [ -z "$INFRA_STACK_NAME" ] || [ -z "$ARTIFACT_BUCKET" ]; then
            echo "Missing CloudFormation config (dev)." >&2
            echo "INFRA_STACK_NAME=$INFRA_STACK_NAME" >&2
            echo "EXEC_ROLE_ARN=$EXEC_ROLE_ARN" >&2
            echo "ARTIFACT_BUCKET=$ARTIFACT_BUCKET" >&2
            exit 1
          fi

          ROLE_ARG=()
          if [ -n "$EXEC_ROLE_ARN" ]; then ROLE_ARG=(--role-arn "$EXEC_ROLE_ARN"); fi
          DEVELOPER_PRINCIPAL_ARN="${{ secrets.DEVELOPER_PRINCIPAL_ARN }}"
          if [ -z "$DEVELOPER_PRINCIPAL_ARN" ]; then DEVELOPER_PRINCIPAL_ARN="${{ vars.DEVELOPER_PRINCIPAL_ARN }}"; fi
          GITHUB_ORG="${{ vars.GITHUB_ORG }}"
          GITHUB_REPO="${{ vars.GITHUB_REPO }}"
          if [ -z "$GITHUB_ORG" ] || [ -z "$GITHUB_REPO" ]; then
            REPO_FULL="${GITHUB_REPOSITORY:-OWNER/REPO}"
            if [ -z "$GITHUB_ORG" ]; then GITHUB_ORG="${REPO_FULL%%/*}"; fi
            if [ -z "$GITHUB_REPO" ]; then GITHUB_REPO="${REPO_FULL##*/}"; fi
          fi

          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          DEV_FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET_DEV }}"
          if [ -z "$DEV_FRONTEND_BUCKET" ]; then DEV_FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET }}"; fi
          if [ -z "$DEV_FRONTEND_BUCKET" ]; then DEV_FRONTEND_BUCKET="kondate-loop-dev-s3-web-211669976488-ap-northeast-1"; fi
          DEV_FRONTEND_BUCKET="${DEV_FRONTEND_BUCKET#arn:aws:s3:::}"

          PROD_FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET_PROD }}"
          if [ -z "$PROD_FRONTEND_BUCKET" ]; then PROD_FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET }}"; fi
          if [ -z "$PROD_FRONTEND_BUCKET" ]; then PROD_FRONTEND_BUCKET="kondate-loop-prod-s3-web-211669976488-ap-northeast-1"; fi
          PROD_FRONTEND_BUCKET="${PROD_FRONTEND_BUCKET#arn:aws:s3:::}"

          DEV_BACKEND_CODE_BUCKET="${{ vars.BACKEND_CODE_BUCKET_DEV }}"
          if [ -z "$DEV_BACKEND_CODE_BUCKET" ]; then DEV_BACKEND_CODE_BUCKET="kondate-loop-dev-s3-lcode-${ACCOUNT_ID}-${AWS_REGION}"; fi
          DEV_BACKEND_CODE_BUCKET="${DEV_BACKEND_CODE_BUCKET#arn:aws:s3:::}"

          ENABLE_GSI1="${{ vars.DDB_ENABLE_GSI1_DEV }}"
          if [ -z "$ENABLE_GSI1" ]; then ENABLE_GSI1="true"; fi
          ENABLE_GSI2="${{ vars.DDB_ENABLE_GSI2_DEV }}"
          if [ -z "$ENABLE_GSI2" ]; then ENABLE_GSI2="false"; fi
          ENABLE_GSI3="${{ vars.DDB_ENABLE_GSI3_DEV }}"
          if [ -z "$ENABLE_GSI3" ]; then ENABLE_GSI3="false"; fi

          PROD_BACKEND_CODE_BUCKET="${{ vars.BACKEND_CODE_BUCKET_PROD }}"
          if [ -z "$PROD_BACKEND_CODE_BUCKET" ]; then PROD_BACKEND_CODE_BUCKET="kondate-loop-prod-s3-lcode-${ACCOUNT_ID}-${AWS_REGION}"; fi
          PROD_BACKEND_CODE_BUCKET="${PROD_BACKEND_CODE_BUCKET#arn:aws:s3:::}"

          delete_if_rollback() {
            local stack="$1"
            local status
            status=$(aws cloudformation describe-stacks --stack-name "$stack" --query "Stacks[0].StackStatus" --output text 2>/dev/null || true)
            if [ "$status" = "ROLLBACK_COMPLETE" ]; then
              if [ "${ALLOW_STACK_DELETE:-}" = "true" ]; then
                echo "Stack in ROLLBACK_COMPLETE. Deleting $stack..." >&2
                aws cloudformation delete-stack --stack-name "$stack"
                aws cloudformation wait stack-delete-complete --stack-name "$stack"
              else
                echo "Stack in ROLLBACK_COMPLETE. Set ALLOW_STACK_DELETE=true to delete and recreate." >&2
                exit 1
              fi
            fi
          }

          LAMBDA_EXEC_ROLE_ARN=""
          STACKS=()
          if [[ "${GITHUB_REF:-}" == refs/heads/feature/* ]]; then
            echo "Feature branch detected. Deploying dev OIDC IAM stack and backend stack."
            STACKS=(
              "kondate-loop-iam-github-oidc-stack|infra/aws-resources/kondate-loop-iam-github-oidc-stack.yaml"
              "kondate-loop-backend-stack|infra/aws-resources/kondate-loop-backend-stack.yaml"
            )
          else
            STACKS=(
              "kondate-loop-iam-github-oidc-stack|infra/aws-resources/kondate-loop-iam-github-oidc-stack.yaml"
              "kondate-loop-iam-LambdaExecutionRole-stack|infra/aws-resources/kondate-loop-iam-LambdaExecutionRole-stack.yaml"
              "kondate-loop-iam-stack|infra/aws-resources/kondate-loop-iam-stack.yaml"
              "${INFRA_STACK_NAME}|infra/aws-resources/kondate-loop-infra-stack.yaml"
              "kondate-loop-backend-stack|infra/aws-resources/kondate-loop-backend-stack.yaml"
            )
          fi

          for entry in "${STACKS[@]}"; do
            IFS='|' read -r STACK_NAME TEMPLATE_FILE <<< "$entry"

            PARAM_OVERRIDES=()
            case "$TEMPLATE_FILE" in
              *kondate-loop-iam-github-oidc-stack.yaml)
                PARAM_OVERRIDES=(
                  "GitHubOrg=$GITHUB_ORG"
                  "GitHubRepo=$GITHUB_REPO"
                  "DevFrontendBucketName=$DEV_FRONTEND_BUCKET"
                  "ProdFrontendBucketName=$PROD_FRONTEND_BUCKET"
                  "ArtifactsBucketName=$ARTIFACT_BUCKET"
                  "DevBackendCodeBucketName=$DEV_BACKEND_CODE_BUCKET"
                  "ProdBackendCodeBucketName=$PROD_BACKEND_CODE_BUCKET"
                  "DevStackName=kondate-loop-backend-stack"
                  "ProdStackName=PRODkondate-loop-backend-stack"
                )
                ;;
              *kondate-loop-backend-stack.yaml)
                PARAM_OVERRIDES=(
                  "Env=$ENV_NAME"
                  "EnableGSI1=$ENABLE_GSI1"
                  "EnableGSI2=$ENABLE_GSI2"
                  "EnableGSI3=$ENABLE_GSI3"
                  "LambdaCodeS3Bucket=${LAMBDA_CODE_S3_BUCKET}"
                  "LambdaCodeS3Key=${LAMBDA_CODE_S3_KEY}"
                  "LambdaHandler=dist/lambda.handler"
                  "ApiDeploymentVersion=${GITHUB_SHA}"
                )
                ;;
              *)
                PARAM_OVERRIDES=("Env=$ENV_NAME")
                ;;
            esac

            if [ "$TEMPLATE_FILE" = "infra/aws-resources/kondate-loop-iam-stack.yaml" ]; then
              if [ -z "$DEVELOPER_PRINCIPAL_ARN" ]; then
                echo "DEVELOPER_PRINCIPAL_ARN is not set; skipping $STACK_NAME." >&2
                continue
              fi
              if [ -z "$LAMBDA_EXEC_ROLE_ARN" ]; then
                LAMBDA_EXEC_ROLE_ARN=$(aws cloudformation describe-stacks \
                  --stack-name "kondate-loop-iam-LambdaExecutionRole-stack" \
                  --query "Stacks[0].Outputs[?OutputKey=='LambdaExecutionRoleArn'].OutputValue" \
                  --output text 2>/dev/null || true)
              fi
              if [ -z "$LAMBDA_EXEC_ROLE_ARN" ]; then
                echo "LambdaExecutionRoleArn not found for kondate-loop-iam-LambdaExecutionRole-stack." >&2
                exit 1
              fi
              PARAM_OVERRIDES+=("DeveloperPrincipalArn=$DEVELOPER_PRINCIPAL_ARN" "LambdaExecutionRoleArn=$LAMBDA_EXEC_ROLE_ARN")
            fi

            delete_if_rollback "$STACK_NAME"

            PARAM_ARGS=()
            if [ "${#PARAM_OVERRIDES[@]}" -gt 0 ]; then
              PARAM_ARGS=(--parameter-overrides "${PARAM_OVERRIDES[@]}")
            fi

            aws cloudformation deploy \
              --template-file "$TEMPLATE_FILE" \
              --stack-name "$STACK_NAME" \
              --s3-bucket "$ARTIFACT_BUCKET" \
              --no-fail-on-empty-changeset \
              "${ROLE_ARG[@]}" \
              --capabilities CAPABILITY_NAMED_IAM \
              "${PARAM_ARGS[@]}"
          done

      - name: Smoke test backend API -> DynamoDB (dev)
        run: |
          set -euo pipefail
          API_BASE=$(aws cloudformation describe-stacks \
            --stack-name "kondate-loop-backend-stack" \
            --query "Stacks[0].Outputs[?OutputKey=='BackendApiEndpoint'].OutputValue" \
            --output text)
          TABLE_NAME=$(aws cloudformation describe-stacks \
            --stack-name "kondate-loop-backend-stack" \
            --query "Stacks[0].Outputs[?OutputKey=='MainTableName'].OutputValue" \
            --output text)
          echo "API_BASE=${API_BASE}"
          echo "TABLE_NAME=${TABLE_NAME}"

          TEST_USER_ID="gha-smoke-${GITHUB_RUN_ID}"
          TEST_TITLE="GHA Smoke ${GITHUB_SHA::7}"
          SMOKE_EMAIL="gha-smoke-${GITHUB_RUN_ID}-${GITHUB_SHA::7}@example.com"
          SMOKE_PASSWORD="GhaSmoke123!"
          AUTH_SIGNUP_URL="${API_BASE%/v1}/v1/auth/signup"
          AUTH_HTTP_CODE=$(curl -sS -o /tmp/auth_signup_response.json -w "%{http_code}" \
            -X POST "${AUTH_SIGNUP_URL}" \
            -H "content-type: application/json" \
            -d "{\"name\":\"GHA Smoke User\",\"email\":\"${SMOKE_EMAIL}\",\"password\":\"${SMOKE_PASSWORD}\"}")
          AUTH_RESPONSE=$(cat /tmp/auth_signup_response.json)
          echo "POST ${AUTH_SIGNUP_URL} -> ${AUTH_HTTP_CODE}"
          echo "Auth response: ${AUTH_RESPONSE}"
          if [ "${AUTH_HTTP_CODE}" != "200" ]; then
            echo "Auth bootstrap failed in smoke test." >&2
            exit 1
          fi
          SMOKE_ACCESS_TOKEN=$(python -c "import sys,json; print((json.load(sys.stdin).get('data') or {}).get('accessToken',''))" <<< "${AUTH_RESPONSE}")
          SMOKE_USER_ID=$(python -c "import sys,json; print((((json.load(sys.stdin).get('data') or {}).get('user') or {}).get('id','')))" <<< "${AUTH_RESPONSE}")
          if [ -z "${SMOKE_ACCESS_TOKEN}" ] || [ -z "${SMOKE_USER_ID}" ]; then
            echo "Auth bootstrap did not return accessToken/user.id." >&2
            exit 1
          fi
          CANDIDATE_URLS=(
            "${API_BASE}/recipes"
            "${API_BASE}/v1/recipes"
            "${API_BASE%/v1}/v1/recipes"
            "${API_BASE%/v1}/recipes"
          )

          RECIPE_ID=""
          for URL in "${CANDIDATE_URLS[@]}"; do
            HTTP_CODE=$(curl -sS -o /tmp/recipe_response.json -w "%{http_code}" \
              -X POST "${URL}" \
              -H "content-type: application/json" \
              -H "authorization: Bearer ${SMOKE_ACCESS_TOKEN}" \
              -d "{\"userId\":\"${TEST_USER_ID}\",\"title\":\"${TEST_TITLE}\",\"servings\":2}")
            RESPONSE=$(cat /tmp/recipe_response.json)
            echo "POST ${URL} -> ${HTTP_CODE}"
            echo "API response: ${RESPONSE}"
            if [ "${HTTP_CODE}" = "200" ] || [ "${HTTP_CODE}" = "201" ]; then
              RECIPE_ID=$(python -c "import sys,json; print((json.load(sys.stdin).get('data') or {}).get('id',''))" <<< "${RESPONSE}")
              if [ -n "${RECIPE_ID}" ]; then
                break
              fi
            fi
          done
          if [ -z "${RECIPE_ID}" ]; then
            echo "Recipe ID not returned from API. Falling back to direct Lambda invoke..." >&2
            PAYLOAD_FILE=/tmp/lambda_recipe_payload.json
            RESPONSE_FILE=/tmp/lambda_recipe_response.json
            printf '%s' "{\"resource\":\"/v1/{proxy+}\",\"path\":\"/v1/recipes\",\"httpMethod\":\"POST\",\"headers\":{\"content-type\":\"application/json\",\"authorization\":\"Bearer ${SMOKE_ACCESS_TOKEN}\"},\"requestContext\":{\"stage\":\"dev\",\"path\":\"/dev/v1/recipes\"},\"body\":\"{\\\"userId\\\":\\\"${TEST_USER_ID}\\\",\\\"title\\\":\\\"${TEST_TITLE}\\\",\\\"servings\\\":2}\",\"isBase64Encoded\":false}" > "${PAYLOAD_FILE}"
            aws lambda invoke \
              --function-name "kondate-loop-dev-api-fn-proxy" \
              --payload "fileb://${PAYLOAD_FILE}" \
              "${RESPONSE_FILE}" >/tmp/lambda_invoke_meta.json
            LAMBDA_STATUS=$(python -c "import json; print(json.load(open('/tmp/lambda_invoke_meta.json')).get('StatusCode',''))")
            LAMBDA_BODY=$(python -c "import json; print(json.load(open('${RESPONSE_FILE}')).get('body',''))")
            echo "Lambda invoke status: ${LAMBDA_STATUS}"
            echo "Lambda response body: ${LAMBDA_BODY}"
            RECIPE_ID=$(python -c "import sys,json; body=json.loads(sys.stdin.read() or '{}'); data=body.get('data') or {}; print(data.get('id',''))" <<< "${LAMBDA_BODY}")
            if [ -z "${RECIPE_ID}" ]; then
              echo "Recipe ID not returned from API nor Lambda invoke." >&2
              exit 1
            fi
          fi

          PK="USER#${SMOKE_USER_ID}"
          SK="RECIPE#${RECIPE_ID}"
          ITEM_PK=$(aws dynamodb get-item \
            --table-name "${TABLE_NAME}" \
            --consistent-read \
            --key "{\"PK\":{\"S\":\"${PK}\"},\"SK\":{\"S\":\"${SK}\"}}" \
            --query "Item.PK.S" \
            --output text)

          if [ "${ITEM_PK}" != "${PK}" ]; then
            echo "DynamoDB verification failed. expected PK=${PK}, actual=${ITEM_PK}" >&2
            exit 1
          fi
          echo "Smoke test passed: ${PK} / ${SK}"

  frontend-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    needs: backend-dev
    concurrency:
      group: deploy-dev
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}

      - name: Verify caller
        run: aws sts get-caller-identity

      - name: Build frontend
        run: |
          set -euo pipefail
          npm ci --include=optional
          node -e "require.resolve('@rollup/rollup-linux-x64-gnu')" || npm -w apps/web i --no-save @rollup/rollup-linux-x64-gnu
          npm run build --workspace=packages/types
          DEV_API_BASE_URL="${{ vars.VITE_API_BASE_URL_DEV }}"
          if [ -z "$DEV_API_BASE_URL" ]; then
            DEV_API_BASE_URL=$(aws cloudformation describe-stacks \
              --stack-name "kondate-loop-backend-stack" \
              --query "Stacks[0].Outputs[?OutputKey=='BackendApiEndpoint'].OutputValue" \
              --output text)
            DEV_API_BASE_URL="${DEV_API_BASE_URL%/v1}"
          fi
          echo "VITE_API_BASE_URL=$DEV_API_BASE_URL"
          VITE_API_USE_MOCK=false VITE_API_BASE_URL="$DEV_API_BASE_URL" npm run build --workspace=apps/web

      - name: Upload frontend to S3 (dev)
        run: |
          FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET_DEV }}"
          if [ -z "$FRONTEND_BUCKET" ]; then FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET }}"; fi
          if [ -z "$FRONTEND_BUCKET" ]; then FRONTEND_BUCKET="kondate-loop-dev-s3-web-211669976488-ap-northeast-1"; fi
          FRONTEND_BUCKET="${FRONTEND_BUCKET#arn:aws:s3:::}"
          if [ -z "$FRONTEND_BUCKET" ]; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            FRONTEND_BUCKET="kondate-loop-dev-s3-web-${ACCOUNT_ID}-${AWS_REGION}"
          fi
          echo "FRONTEND_BUCKET=$FRONTEND_BUCKET"
          aws s3 sync apps/web/dist "s3://${FRONTEND_BUCKET}/" --delete

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-prod
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Resolve prod role
        id: prod-role
        run: |
          ROLE_ARN="${{ vars.AWS_ROLE_ARN_PROD }}"

          if [ -z "$ROLE_ARN" ]; then
            echo "::warning::Repository variable AWS_ROLE_ARN_PROD is not configured. Skipping prod deploy."
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "enabled=true" >> "$GITHUB_OUTPUT"
          echo "role_arn=$ROLE_ARN" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (OIDC)
        if: steps.prod-role.outputs.enabled == 'true'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
          role-to-assume: ${{ steps.prod-role.outputs.role_arn }}

      - name: Deploy CloudFormation (prod)
        if: steps.prod-role.outputs.enabled == 'true'
        run: |
          ENV_NAME=prod
          INFRA_STACK_NAME="${{ vars.CFN_STACK_NAME_PROD }}"
          if [ -z "$INFRA_STACK_NAME" ]; then INFRA_STACK_NAME="${{ vars.CFN_STACK_NAME }}"; fi
          if [ -z "$INFRA_STACK_NAME" ]; then INFRA_STACK_NAME="kondate-loop-infra-stack-${ENV_NAME}"; fi

          EXEC_ROLE_ARN="${{ secrets.CFN_EXEC_ROLE_ARN_PROD }}"
          if [ -z "$EXEC_ROLE_ARN" ]; then EXEC_ROLE_ARN="${{ vars.CFN_EXEC_ROLE_ARN_PROD }}"; fi
          if [ -z "$EXEC_ROLE_ARN" ]; then EXEC_ROLE_ARN="${{ vars.CFN_EXEC_ROLE_ARN }}"; fi

          ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_PROD }}"
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET }}"; fi
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="${{ vars.CFN_ARTIFACT_BUCKET_NAME }}"; fi
          if [ -z "$ARTIFACT_BUCKET" ]; then ARTIFACT_BUCKET="kondate-loop-infra-s3-artifacts-211669976488-ap-northeast-1"; fi
          ARTIFACT_BUCKET="${ARTIFACT_BUCKET#arn:aws:s3:::}"

          if [ -z "$INFRA_STACK_NAME" ] || [ -z "$ARTIFACT_BUCKET" ]; then
            echo "Missing CloudFormation config (prod)." >&2
            echo "INFRA_STACK_NAME=$INFRA_STACK_NAME" >&2
            echo "EXEC_ROLE_ARN=$EXEC_ROLE_ARN" >&2
            echo "ARTIFACT_BUCKET=$ARTIFACT_BUCKET" >&2
            exit 1
          fi

          ROLE_ARG=()
          if [ -n "$EXEC_ROLE_ARN" ]; then ROLE_ARG=(--role-arn "$EXEC_ROLE_ARN"); fi

          ENABLE_GSI1="${{ vars.DDB_ENABLE_GSI1_PROD }}"
          if [ -z "$ENABLE_GSI1" ]; then ENABLE_GSI1="true"; fi
          ENABLE_GSI2="${{ vars.DDB_ENABLE_GSI2_PROD }}"
          if [ -z "$ENABLE_GSI2" ]; then ENABLE_GSI2="false"; fi
          ENABLE_GSI3="${{ vars.DDB_ENABLE_GSI3_PROD }}"
          if [ -z "$ENABLE_GSI3" ]; then ENABLE_GSI3="false"; fi

          STACKS=(
            "${INFRA_STACK_NAME}|infra/aws-resources/PROD/PRODkondate-loop-infra-stack.yaml"
            "PRODkondate-loop-backend-stack|infra/aws-resources/PROD/PRODkondate-loop-backend-stack.yaml"
          )

          for entry in "${STACKS[@]}"; do
            IFS='|' read -r STACK_NAME TEMPLATE_FILE <<< "$entry"

            PARAM_OVERRIDES=("Env=$ENV_NAME")
            if [ "$TEMPLATE_FILE" = "infra/aws-resources/PROD/PRODkondate-loop-infra-stack.yaml" ]; then
              PARAM_OVERRIDES+=(
                "SharedArtifactBucketName=$ARTIFACT_BUCKET"
                "SharedArtifactBucketArn=arn:aws:s3:::$ARTIFACT_BUCKET"
              )
            fi
            if [ "$TEMPLATE_FILE" = "infra/aws-resources/PROD/PRODkondate-loop-backend-stack.yaml" ]; then
              PARAM_OVERRIDES+=(
                "EnableGSI1=$ENABLE_GSI1"
                "EnableGSI2=$ENABLE_GSI2"
                "EnableGSI3=$ENABLE_GSI3"
              )
            fi

            aws cloudformation deploy \
              --template-file "$TEMPLATE_FILE" \
              --stack-name "$STACK_NAME" \
              --s3-bucket "$ARTIFACT_BUCKET" \
              --no-fail-on-empty-changeset \
              "${ROLE_ARG[@]}" \
              --capabilities CAPABILITY_NAMED_IAM \
              --parameter-overrides "${PARAM_OVERRIDES[@]}"
          done

      - name: Build frontend
        if: steps.prod-role.outputs.enabled == 'true'
        run: |
          npm ci --include=optional
          node -e "require.resolve('@rollup/rollup-linux-x64-gnu')" || npm -w apps/web i --no-save @rollup/rollup-linux-x64-gnu
          npm run build --workspace=packages/types
          npm run build --workspace=apps/web

      - name: Upload frontend to S3 (prod)
        if: steps.prod-role.outputs.enabled == 'true'
        run: |
          FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET_PROD }}"
          if [ -z "$FRONTEND_BUCKET" ]; then FRONTEND_BUCKET="${{ vars.FRONTEND_BUCKET }}"; fi
          if [ -z "$FRONTEND_BUCKET" ]; then FRONTEND_BUCKET="kondate-loop-prod-s3-web-211669976488-ap-northeast-1"; fi
          FRONTEND_BUCKET="${FRONTEND_BUCKET#arn:aws:s3:::}"
          if [ -z "$FRONTEND_BUCKET" ]; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            FRONTEND_BUCKET="kondate-prod-s3-web-${ACCOUNT_ID}-${AWS_REGION}"
          fi
          echo "FRONTEND_BUCKET=$FRONTEND_BUCKET"
          aws s3 sync apps/web/dist "s3://${FRONTEND_BUCKET}/" --delete
