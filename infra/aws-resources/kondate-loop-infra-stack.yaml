# yaml-language-server: $schema=https://raw.githubusercontent.com/awslabs/goformation/master/schema/cloudformation.schema.json
AWSTemplateFormatVersion: '2010-09-09'
Description: Minimal infra static (CloudFront + S3)

Parameters:
  SystemId:
    Type: String
    Default: 'kondate-loop'
    Description: SystemId
  CorsAllowOrigin:
    Type: String
    Default: '*'
    Description: Allowed origin for API CORS. Use a specific domain for production.
  Env:
    Type: String
    Default: 'dev'
    AllowedValues:
      - 'dev'
      - 'prod'
    Description: Environment

  SharedArtifactBucketName:
    Type: String
    Default: ''
    Description: >
      If set, this stack will NOT create ArtifactBucket and will use the given bucket name instead.
      Leave empty in the stack that creates the shared bucket (typically dev/bootstrap stack).

  SharedArtifactBucketArn:
    Type: String
    Default: ''
    Description: >
      ARN of the shared ArtifactBucket. Required when SharedArtifactBucketName is set (for Outputs).

Conditions:
  CreateArtifactBucket: !Equals [!Ref SharedArtifactBucketName, '']

Resources:
  StaticBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${SystemId}-${Env}-s3-web-${AWS::AccountId}-${AWS::Region}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Owner
          Value: yukanagatake

  ArtifactBucket:
    Type: AWS::S3::Bucket
    Condition: CreateArtifactBucket
    Properties:
      BucketName: !Sub '${SystemId}-infra-s3-artifacts-${AWS::AccountId}-${AWS::Region}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldArtifacts
            Status: Enabled
            ExpirationInDays: 90
      Tags:
        - Key: Owner
          Value: yukanagatake

  BackendCodeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${SystemId}-${Env}-s3-lambda-code-${AWS::AccountId}-${AWS::Region}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldLambdaCodeVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 90
      Tags:
        - Key: Owner
          Value: yukanagatake

  StaticBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StaticBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontRead
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub '${StaticBucket.Arn}/*'
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: StaticS3
            DomainName: !GetAtt StaticBucket.RegionalDomainName
            OriginAccessControlId: !Ref StaticOriginAccessControl
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: StaticS3
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: !Ref StaticCachePolicy
      Tags:
        - Key: Owner
          Value: yukanagatake

  StaticCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub '${SystemId}-${Env}-cf-cachepolicy-static'
        DefaultTTL: 86400
        MaxTTL: 31536000
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          CookiesConfig:
            CookieBehavior: none
          HeadersConfig:
            HeaderBehavior: none
          QueryStringsConfig:
            QueryStringBehavior: none
          EnableAcceptEncodingBrotli: true
          EnableAcceptEncodingGzip: true

  StaticOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${SystemId}-${Env}-cf-oac-static'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

Outputs:
  ArtifactBucketName:
    Description: Artifact bucket name (shared across env)
    Value: !If
      - CreateArtifactBucket
      - !Ref ArtifactBucket
      - !Ref SharedArtifactBucketName

  ArtifactBucketArn:
    Description: Artifact bucket ARN (shared across env)
    Value: !If
      - CreateArtifactBucket
      - !GetAtt ArtifactBucket.Arn
      - !Ref SharedArtifactBucketArn

  BackendCodeBucketName:
    Description: Backend Lambda code bucket name
    Value: !Ref BackendCodeBucket
    Export:
      Name: !Sub '${SystemId}-${Env}-backend-code-bucket-name'

  BackendCodeBucketArn:
    Description: Backend Lambda code bucket ARN
    Value: !GetAtt BackendCodeBucket.Arn
    Export:
      Name: !Sub '${SystemId}-${Env}-backend-code-bucket-arn'
